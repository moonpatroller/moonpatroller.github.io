<!doctype html>
<html>
<head>
	<title>Canvas Test</title>
</head>
<body>

<canvas id="tutorial" width="500" height="500">
	Canvas not supported.
</canvas>
<div id="info"> </div>
<script>

var info = document.getElementById('info');

var canvas = document.getElementById('tutorial');
canvas.style.cursor = 'none';

var ctx = canvas.getContext('2d');
var guy_img = new Image();
var crystals_img = new Image();

var pointer = {
	x: 0,
	y: 0,
	draw: function(ctx) {
		ctx.beginPath();
		ctx.arc(this.x, this.y, 2, 0, 2 * Math.PI, true);
		ctx.stroke();
	}
};

var guy = {
	xPos: 100,
	yPos: 100,
	facing: 'right',
	draw: function(ctx, viewLeft, viewTop) {
		switch (this.facing) {
			// case "up":   break;
			// case "down": break;

			case "left":
				var width = 176 - 163;
				var height = 31;
				ctx.drawImage(guy_img, 163, 34, width, height, 
					this.xPos - viewLeft, this.yPos - viewTop, width, height);
			break;

			default: // right
				var width = 11;
				var height = 31;
				ctx.drawImage(guy_img, 2, 34, width, height, 
					this.xPos - viewLeft, this.yPos - viewTop, width, height);
			break;
		}
	}
};

var keyboard = {};

var world = {
	width:  100000,  // in pixels
	height: 100000,
	rocks: [],
	getRock: function(x, y) {
		return this.rocks[y * this.width / 100 + x];
	}
};
for (var x = 0; x < world.width / 100; x++) {
	for (var y = 0; y < world.height / 100; y++) {
		world.rocks[y * world.width / 100 + x] = Math.floor(Math.random() * 20);
	}
}

viewTop = 0;
viewLeft = 0;

function init() {

	guy_img.addEventListener("load", function() {
		crystals_img.addEventListener("load", function() {
			window.requestAnimationFrame(draw);
		}, false);
	}, false);

	guy_img.src = 'keen_clear.png';
	crystals_img.src = 'crystals_clear.png';
}

function drawCrystal(n, x, y) {
	var height = 66;
	var width = 56;
	ctx.drawImage(crystals_img, 278, n * 68, width, height, x, y, width, height);
	// ctx.strokeRect(x, y, width, height);
}

var background_color = 'rgb(' +
	Math.floor(Math.random() * 255) + ', ' +
	Math.floor(Math.random() * 255) + ', ' +
	Math.floor(Math.random() * 255) + ')';

function draw() {
	ctx.clearRect(0, 0, 500, 500);

	ctx.fillStyle = background_color;
	ctx.fillRect(0, 0, 500, 500);

	if (keyboard.left) {
		guy.xPos -= 1;
		if (guy.xPos < 0) {
			guy.xPos = world.width - 1;
		}
		guy.facing = 'left';
	}
	else if (keyboard.right) {
		guy.xPos = (guy.xPos + 1) % world.width;
		guy.facing = 'right';
	}
	else if (keyboard.up) {
		guy.yPos -= 1;
		if (guy.yPos < 0) {
			guy.yPos = world.height - 1;
		}
	}
	else if (keyboard.down) {
		guy.yPos = (guy.yPos + 1) % world.height;
	}

	if (guy.yPos > viewTop + canvas.height * 0.8) {
		viewTop = Math.floor(guy.yPos - canvas.height * 0.8);
	}
	else if (guy.yPos < viewTop + canvas.height * 0.2) {
		viewTop = Math.floor(guy.yPos - canvas.height * 0.2);
	}

	if (guy.xPos > viewLeft + canvas.width * 0.8) {
		viewLeft = Math.floor(guy.xPos - canvas.width * 0.8);
	}
	else if (guy.xPos < viewLeft + canvas.width * 0.2) {
		viewLeft = Math.floor(guy.xPos - canvas.width * 0.2);
	}

	// col and row here are for rocks, constrain to appearing every 100px.
	var firstCol = Math.min(world.width  / 100 - 1, Math.max(0, Math.floor(viewLeft / 100)));
	var firstRow = Math.min(world.height / 100 - 1, Math.max(0, Math.floor(viewTop  / 100)));

	info.innerHTML = 'viewTop: ' + viewTop + ', guy.yPos: ' + guy.yPos + 
		', viewLeft: ' + viewLeft + ', guy.xPos: ' + guy.xPos + 
		', firstRow: ' + firstRow + ', firstCol: ' + firstCol;

	for (var x = 0; x < 6; x++) {
		for (var y = 0; y < 6; y++) {
			var rockNum = world.getRock(firstCol + x, firstRow + y);
			if (rockNum < 5) {
				drawCrystal(rockNum, 
					x * 100 + 25 - (viewLeft % 100), 
					y * 100 + 25 - (viewTop  % 100));
			}
		}
	}

	guy.draw(ctx, viewLeft, viewTop);
	pointer.draw(ctx);

	ctx.strokeStyle = "rgb(0,0,0)";
	ctx.strokeRect(0, 0, 500, 500);
	window.requestAnimationFrame(draw);
}

document.addEventListener('keydown', (event) => {
	switch (event.key) {
		case "ArrowLeft":
			keyboard.left  = true;
			keyboard.right = false;
			break;
		case "ArrowRight":
			keyboard.left  = false;
			keyboard.right = true;
			break;
		case "ArrowUp":
			keyboard.up   = true;
			keyboard.down = false;
			break;
		case "ArrowDown":
			keyboard.up   = false;
			keyboard.down = true;
			break;
	}
});

document.addEventListener('keyup', (event) => {
	switch (event.key) {
		case "ArrowLeft":  keyboard.left  = false; break;
		case "ArrowRight": keyboard.right = false; break;
		case "ArrowUp":    keyboard.up    = false; break;
		case "ArrowDown":  keyboard.down  = false; break;
	}
});

canvas.addEventListener('mousemove', (event) => {
	pointer.x = event.clientX;
	pointer.y = event.clientY;
});

canvas.addEventListener('contextmenu', function (e) { // Not compatible with IE < 9
    e.preventDefault();
}, false);

init();

</script>

</body>
</html>